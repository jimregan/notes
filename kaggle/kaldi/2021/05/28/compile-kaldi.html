<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Compiling Kaldi on Kaggle | notes</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Compiling Kaldi on Kaggle" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Kaldi is a bit of a beast to install" />
<meta property="og:description" content="Kaldi is a bit of a beast to install" />
<link rel="canonical" href="https://jimregan.github.io/notes/kaggle/kaldi/2021/05/28/compile-kaldi.html" />
<meta property="og:url" content="https://jimregan.github.io/notes/kaggle/kaldi/2021/05/28/compile-kaldi.html" />
<meta property="og:site_name" content="notes" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-05-28T00:00:00-05:00" />
<script type="application/ld+json">
{"url":"https://jimregan.github.io/notes/kaggle/kaldi/2021/05/28/compile-kaldi.html","@type":"BlogPosting","headline":"Compiling Kaldi on Kaggle","dateModified":"2021-05-28T00:00:00-05:00","datePublished":"2021-05-28T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://jimregan.github.io/notes/kaggle/kaldi/2021/05/28/compile-kaldi.html"},"description":"Kaldi is a bit of a beast to install","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/notes/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://jimregan.github.io/notes/feed.xml" title="notes" /><link rel="shortcut icon" type="image/x-icon" href="/notes/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper">
    <a class="site-title" rel="author" href="/notes/">notes</a>
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon"></span>
        </label>

        <div class="nav-items">
  <a class="nav-item" href="/notes/about/">About Me</a>
  <a class="nav-item" href="/notes/search/">Search</a>
  <a class="nav-item" href="/notes/categories/">Tags</a>
</div>

      </nav>
  </div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Compiling Kaldi on Kaggle</h1><p class="page-description">Kaldi is a bit of a beast to install</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-05-28T00:00:00-05:00" itemprop="datePublished">
        May 28, 2021
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      8 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/notes/categories/#kaggle">kaggle</a>
        &nbsp;
      
        <a class="category-tags-link" href="/notes/categories/#kaldi">kaldi</a>
        
      
      </p>
    

    
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-05-28-compile-kaldi.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="https://www.kaggle.com/jimregan/compile-kaldi">Original</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Kaldi is a bit of a beast to install. I tried to get around it by <a href="https://www.kaggle.com/jimregan/extract-prebuilt-kaldi-from-docker">extracting files from the official docker image</a>: tl;dr, it works fine for the tools that run on CPU, but the GPU-based tools depend on CUDA 10.0, while Kaggle's GPU images use CUDA 11.0.</p>
<p>I'm building this in <code>/opt</code> to match the docker extraction notebook.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">cd</span> /opt
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>git clone https://github.com/kaldi-asr/kaldi
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I'm installing cudatoolkit to make sure it's there, and the same version as the one in the gpu docker image, because issues with that are why I'm compiling this in the first place. You can quite possibly get away with not running this step, but I'm not taking a chance on it. If you are going to re-run this, make sure to check the <a href="https://github.com/Kaggle/docker-python/blob/main/gpu.Dockerfile">gpu docker image</a> to match the version for cudatoolkit.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="ch">#!conda install cudatoolkit=11.0 -y</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>conda install cudatoolkit-dev<span class="o">=</span><span class="m">11</span>.0
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%capture</span>
<span class="err">!</span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">liblapack</span><span class="o">-</span><span class="n">dev</span> <span class="n">sox</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First step is to follow the instructions in <code>kaldi/tools</code></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">cd</span> /opt/kaldi/tools
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>INSTALL</code> file says to run <code>extras/check_dependencies.sh</code>, fix anything that's missing, and then run <code>make</code>. It's unlikely that new dependencies will be added (Kaldi more in maintenance mode than active development), but just in case, uncomment the line in the next cell and run it.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="ch">#!./extras/check_dependencies.sh</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is what I was missing from the <code>check_dependencies</code> check:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%capture</span>
<span class="err">!</span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">automake</span> <span class="n">autoconf</span> <span class="n">gfortran</span> <span class="n">subversion</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%capture</span>
<span class="err">!</span><span class="n">make</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next,we need a maths library:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%capture</span>
<span class="err">!</span><span class="n">extras</span><span class="o">/</span><span class="n">install_openblas</span><span class="o">.</span><span class="n">sh</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now is the time to build any of the optional dependencies you might want. I want phonetisaurus.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%capture</span>
<span class="err">!</span><span class="n">bash</span> <span class="n">extras</span><span class="o">/</span><span class="n">install_phonetisaurus</span><span class="o">.</span><span class="n">sh</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I had problems with <code>phonetisaurus-apply</code> from the branch installed by <code>install_phonetisaurus.sh</code>, so I'm replacing it with an updated version from the phonetisaurus repo:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> /opt/kaldi/tools/phonetisaurus-g2p/src/scripts/phonetisaurus-apply
<span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- mode: python; coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="k">class</span> <span class="nc">G2PModelTester</span> <span class="p">()</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;G2P Model training wrapper class.</span>

<span class="sd">    Phonetisaurus G2P modeling training wrapper class.</span>
<span class="sd">    This wraps the alignment, joint n-gram training, and ARPA to</span>
<span class="sd">    WFST conversion steps into one command.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lexicon_file</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span> <span class="p">(</span><span class="s2">&quot;lexicon&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbest</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span> <span class="p">(</span><span class="s2">&quot;nbest&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresh</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span> <span class="p">(</span><span class="s2">&quot;thresh&quot;</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span> <span class="p">(</span><span class="s2">&quot;beam&quot;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">greedy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span> <span class="p">(</span><span class="s2">&quot;greedy&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accumulate</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span> <span class="p">(</span><span class="s2">&quot;accumulate&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pmass</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span> <span class="p">(</span><span class="s2">&quot;pmass&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span> <span class="p">(</span><span class="s2">&quot;probs&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span> <span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setupLogger</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">setupLogger</span> <span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Setup the logger and logging level.</span>

<span class="sd">        Setup the logger and logging level.  We only support</span>
<span class="sd">        verbose and non-verbose mode.</span>

<span class="sd">        Args:</span>
<span class="sd">            verbose (bool): Verbose mode, or not.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Logger: A configured logger instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span> <span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[94m</span><span class="si">%(levelname)s</span><span class="s2">:</span><span class="si">%(name)s</span><span class="s2">:&quot;</span>\
            <span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="se">\033</span><span class="s2">[0m:  </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">datefmt</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span> <span class="p">(</span><span class="s2">&quot;phonetisaurus-apply&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_loadLexicon</span> <span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load the lexicon from a file.</span>

<span class="sd">        Load the reference lexicon from a file, and store it</span>
<span class="sd">        in a defaultdict (list).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_lexicon</span> <span class="o">=</span> <span class="n">defaultdict</span> <span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lexicon_file</span> <span class="p">:</span>
            <span class="k">return</span> <span class="n">_lexicon</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="p">(</span><span class="s2">&quot;Loading lexicon from file...&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lexicon_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ifp</span> <span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ifp</span> <span class="p">:</span>
                <span class="c1"># py2py3 compatbility,</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span> <span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span> <span class="p">()</span>
                <span class="n">word</span><span class="p">,</span> <span class="n">pron</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span> <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\t&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">_lexicon</span> <span class="p">[</span><span class="n">word</span><span class="p">]</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">pron</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_lexicon</span>

    <span class="k">def</span> <span class="nf">checkPhonetisaurusConfig</span> <span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run some basic checks before training.</span>

<span class="sd">        Run some basic checks regarding the $PATH, environment,</span>
<span class="sd">        and provided data before starting training.</span>

<span class="sd">        Raises:</span>
<span class="sd">            EnvironmentError: raised if binaries are not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="p">(</span><span class="s2">&quot;Checking command configuration...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">program</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;phonetisaurus-g2pfst&quot;</span><span class="p">]</span> <span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">which</span> <span class="p">(</span><span class="n">program</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s2">&quot;Phonetisaurus command, &#39;</span><span class="si">{0}</span><span class="s2">&#39;, &quot;</span>\
                    <span class="s2">&quot;not found in path.&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="n">program</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lexicon_file</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lexicon_file</span><span class="p">)</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span> <span class="p">(</span><span class="s2">&quot;Could not find provided lexicon file.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span> <span class="p">(</span><span class="nb">vars</span> <span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">items</span> <span class="p">())</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="p">(</span><span class="sa">u</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">:  </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lexicon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadLexicon</span> <span class="p">()</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">which</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Basic &#39;which&#39; implementation for python.</span>

<span class="sd">        Basic &#39;which&#39; implementation for python from stackoverflow:</span>
<span class="sd">          * https://stackoverflow.com/a/377028/6739158</span>

<span class="sd">        Args:</span>
<span class="sd">            program (str): The program name to search the $PATH for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            path/None: The path to the executable, or None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">is_exe</span> <span class="p">(</span><span class="n">fpath</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span> <span class="p">(</span><span class="n">fpath</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span> <span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">)</span>

        <span class="n">fpath</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span> <span class="p">(</span><span class="n">program</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fpath</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_exe</span> <span class="p">(</span><span class="n">program</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">program</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PATH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)</span> <span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">strip</span> <span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
                <span class="n">exe_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">program</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_exe</span> <span class="p">(</span><span class="n">exe_file</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">exe_file</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">makeG2PCommand</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word_list</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Build the G2P command.</span>

<span class="sd">        Build the G2P command from the provided arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: The command in subprocess list format.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">u</span><span class="s2">&quot;phonetisaurus-g2pfst&quot;</span><span class="p">,</span>
            <span class="sa">u</span><span class="s2">&quot;--model=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">),</span>
            <span class="sa">u</span><span class="s2">&quot;--nbest=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbest</span><span class="p">),</span>
            <span class="sa">u</span><span class="s2">&quot;--beam=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">),</span>
            <span class="sa">u</span><span class="s2">&quot;--thresh=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresh</span><span class="p">),</span>
            <span class="sa">u</span><span class="s2">&quot;--accumulate=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="nb">str</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accumulate</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span> <span class="p">()),</span>
            <span class="sa">u</span><span class="s2">&quot;--pmass=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pmass</span><span class="p">),</span>
            <span class="sa">u</span><span class="s2">&quot;--nlog_probs=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span> <span class="p">()),</span>
            <span class="sa">u</span><span class="s2">&quot;--wordlist=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="n">word_list</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="p">(</span><span class="sa">u</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span> <span class="p">(</span><span class="n">command</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">command</span>

    <span class="k">def</span> <span class="nf">runG2PCommand</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word_list_file</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate and run the actual G2P command.</span>

<span class="sd">        Generate and run the actual G2P command.  Each synthesized</span>
<span class="sd">        entry will be yielded back on-the-fly via the subprocess</span>
<span class="sd">        stdout readline method.</span>

<span class="sd">        Args:</span>
<span class="sd">            word_list_file (str): The input word list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">g2p_command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeG2PCommand</span> <span class="p">(</span><span class="n">word_list_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="p">(</span><span class="s2">&quot;Applying G2P model...&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">devnull</span> <span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span> <span class="p">(</span>
                <span class="n">g2p_command</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">devnull</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span> <span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span> <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\t&quot;</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span> <span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span> <span class="p">())</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span> <span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span> <span class="p">(</span>
                        <span class="sa">u</span><span class="s2">&quot;No pronunciation for word: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="n">parts</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">yield</span> <span class="n">parts</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">applyG2POnly</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word_list_file</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Apply the G2P model to a word list.</span>

<span class="sd">        Apply the G2P model to a word list.  No filtering or application</span>
<span class="sd">        of a reference lexicon is used here.</span>

<span class="sd">        Args:</span>
<span class="sd">            word_list_file (str): The input word list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">pron</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runG2PCommand</span> <span class="p">(</span><span class="n">word_list_file</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="si">{1:.2f}</span><span class="se">\t</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span>
                    <span class="n">word</span><span class="p">,</span> <span class="nb">float</span> <span class="p">(</span><span class="n">score</span><span class="p">),</span> <span class="n">pron</span>
                <span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">pron</span><span class="p">)</span>
            <span class="c1"># py2py3 compatbility,</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="nb">print</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">encode</span> <span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">))</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="nb">print</span> <span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">applyG2PWithLexicon</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word_list_file</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Apply the G2P model to a word list, combined with lexicon.</span>

<span class="sd">        Apply the G2P model to a word list, but combine this with</span>
<span class="sd">        a reference lexicon.  Words for which a reference entry exists</span>
<span class="sd">        will not be sent to the G2P, unless the additional &#39;--greedy&#39;</span>
<span class="sd">        flag is set to True.</span>

<span class="sd">        Args:</span>
<span class="sd">            word_list_file (str): The input word list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target_lexicon</span> <span class="o">=</span> <span class="n">defaultdict</span> <span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">tmpwordlist</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1">#First, find any words in the target list for which we already</span>
        <span class="c1"># have a canonical pronunciation in the reference lexicon.</span>
        <span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="n">word_list_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ifp</span> <span class="p">:</span>
            <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">ifp</span> <span class="p">:</span>
                <span class="c1"># py2py3 compatbility,</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">decode</span> <span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span> <span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">strip</span> <span class="p">()</span> <span class="c1"># already in &#39;utf8&#39;.</span>
                <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lexicon</span> <span class="p">:</span>
                    <span class="n">target_lexicon</span> <span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">pron</span><span class="p">)</span>
                                             <span class="k">for</span> <span class="n">pron</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lexicon</span> <span class="p">[</span><span class="n">word</span><span class="p">]]</span>
                    <span class="c1">#In greedy mode we still send words to the G2P, even</span>
                    <span class="c1"># if we have canonical entries in the reference lexicon.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">greedy</span> <span class="p">:</span>
                        <span class="nb">print</span> <span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">encode</span> <span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">tmpwordlist</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="c1"># py2py3 compatbility,</span>
                    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">encode</span> <span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">tmpwordlist</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">tmpwordlist</span><span class="p">)</span>
        <span class="n">tmpwordlist</span><span class="o">.</span><span class="n">close</span> <span class="p">()</span>

        <span class="c1">#Second, iterate through the G2P output, and filter against</span>
        <span class="c1"># any possible duplicates previously found in the reference lexicon.</span>
        <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">pron</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runG2PCommand</span> <span class="p">(</span><span class="n">tmpwordlist</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">prons</span> <span class="o">=</span> <span class="nb">set</span> <span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="n">target_lexicon</span> <span class="p">[</span><span class="n">word</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">pron</span> <span class="ow">in</span> <span class="n">prons</span> <span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">target_lexicon</span> <span class="p">[</span><span class="n">word</span><span class="p">]</span><span class="o">.</span><span class="n">append</span> <span class="p">((</span><span class="n">score</span><span class="p">,</span> <span class="n">pron</span><span class="p">))</span>

        <span class="c1">#Finally, sort everything that is left and print it.</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">sorted</span> <span class="p">(</span><span class="n">target_lexicon</span><span class="o">.</span><span class="n">keys</span> <span class="p">())</span> <span class="p">:</span>
            <span class="k">for</span> <span class="n">score</span><span class="p">,</span> <span class="n">pron</span> <span class="ow">in</span> <span class="n">target_lexicon</span> <span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="si">{1:.2f}</span><span class="se">\t</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span>
                        <span class="n">word</span><span class="p">,</span> <span class="nb">float</span> <span class="p">(</span><span class="n">score</span><span class="p">),</span> <span class="n">pron</span>
                    <span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">pron</span><span class="p">)</span>
                <span class="c1"># py2py3 compatbility,</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">encode</span> <span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">))</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="nb">print</span> <span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span> <span class="p">(</span><span class="n">tmpwordlist</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">ApplyG2PModel</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word_list_file</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Apply the G2P model to a word list.</span>

<span class="sd">        Apply the G2P model to a word list.</span>

<span class="sd">        Args:</span>
<span class="sd">            word_list_file (str): The input word list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkPhonetisaurusConfig</span> <span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span> <span class="p">(</span><span class="n">word_list_file</span><span class="p">)</span> \
           <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span> <span class="p">(</span><span class="n">word_list_file</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Word list file not found.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lexicon</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">applyG2POnly</span> <span class="p">(</span><span class="n">word_list_file</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">applyG2PWithLexicon</span> <span class="p">(</span><span class="n">word_list_file</span><span class="p">)</span>

        <span class="k">return</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span> <span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">argparse</span>

    <span class="n">example</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> --model train/model.fst --word test&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">parser</span>  <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span> <span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">example</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span> <span class="p">(</span><span class="s2">&quot;--model&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Phonetisaurus G2P fst model.&quot;</span><span class="p">,</span>
                         <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span> <span class="p">(</span><span class="s2">&quot;--lexicon&quot;</span><span class="p">,</span> <span class="s2">&quot;-l&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Optional reference lexicon.&quot;</span><span class="p">,</span>
                         <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span> <span class="p">(</span><span class="s2">&quot;--nbest&quot;</span><span class="p">,</span> <span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Maximum number of hypotheses &quot;</span>
                         <span class="s2">&quot;to produce.  Overridden if --pmass is set.&quot;</span><span class="p">,</span>
                         <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span> <span class="p">(</span><span class="s2">&quot;--beam&quot;</span><span class="p">,</span> <span class="s2">&quot;-b&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Search &#39;beam&#39;.&quot;</span><span class="p">,</span>
                         <span class="n">default</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span> <span class="p">(</span><span class="s2">&quot;--thresh&quot;</span><span class="p">,</span> <span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Pruning threshold for n-best.&quot;</span><span class="p">,</span>
                         <span class="n">default</span><span class="o">=</span><span class="mf">99.0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span> <span class="p">(</span><span class="s2">&quot;--greedy&quot;</span><span class="p">,</span> <span class="s2">&quot;-g&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use the G2P even if a &quot;</span>
                         <span class="s2">&quot;reference lexicon has been provided.&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span> <span class="p">(</span><span class="s2">&quot;--accumulate&quot;</span><span class="p">,</span> <span class="s2">&quot;-a&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Accumulate probabilities &quot;</span>
                         <span class="s2">&quot;across unique pronunciations.&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span> <span class="p">(</span><span class="s2">&quot;--pmass&quot;</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Select the maximum number of &quot;</span>
                         <span class="s2">&quot;hypotheses summing to P total mass for a word.&quot;</span><span class="p">,</span>
                         <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span> <span class="p">(</span><span class="s2">&quot;--probs&quot;</span><span class="p">,</span> <span class="s2">&quot;-pr&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print exp(-val) &quot;</span>
                         <span class="s2">&quot;instead of default -log values.&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span> <span class="p">(</span><span class="s2">&quot;--word_list&quot;</span><span class="p">,</span> <span class="s2">&quot;-wl&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Input word or word list to apply &quot;</span>
                        <span class="s2">&quot;G2P model to.&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span> <span class="p">(</span><span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Verbose mode.&quot;</span><span class="p">,</span>
                         <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span> <span class="p">()</span>

    <span class="n">tester</span> <span class="o">=</span> <span class="n">G2PModelTester</span> <span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
        <span class="o">**</span><span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span> <span class="p">()</span>
           <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">,</span><span class="s2">&quot;word_list&quot;</span><span class="p">]}</span>
    <span class="p">)</span>

    <span class="n">tester</span><span class="o">.</span><span class="n">ApplyG2PModel</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">word_list</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">cd</span> /opt/kaldi/src/
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Be sure to uncomment and run the next cell, to make sure nothing's changed; it's unlikely that anything will have changed, though. The following cell does configure, make depend, and make, which is all that the current INSTALL says.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>./configure --shared --use-cuda --mathlib<span class="o">=</span>OPENBLAS
<span class="o">!</span>make depend -j <span class="m">8</span>
<span class="o">!</span>make -j <span class="m">8</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">cd</span> /opt
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Second last step, clean up the object files:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>find /opt/kaldi  -type f <span class="se">\(</span> -name <span class="s2">&quot;*.o&quot;</span> -o -name <span class="s2">&quot;*.la&quot;</span> -o -name <span class="s2">&quot;*.a&quot;</span> <span class="se">\)</span> -exec rm <span class="o">{}</span> <span class="se">\;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>tar cvf /kaggle/working/kaldi.tar kaldi/
</pre></div>

    </div>
</div>
</div>

</div>
    

</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="jimregan/notes"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/notes/kaggle/kaldi/2021/05/28/compile-kaldi.html" hidden></a>
</article>

      </div>
    </main><link id="fa-stylesheet" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css">

<footer class="site-footer h-card">
  <data class="u-url" href="/notes/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="https://jimregan.github.io/notes/feed.xml">
            <svg class="svg-icon orange">
              <path d="M12.8 16C12.8 8.978 7.022 3.2 0 3.2V0c8.777 0 16 7.223 16 16h-3.2zM2.194
                11.61c1.21 0 2.195.985 2.195 2.196 0 1.21-.99 2.194-2.2 2.194C.98 16 0 15.017 0
                13.806c0-1.21.983-2.195 2.194-2.195zM10.606
                16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818 0 10.606 4.79 10.606 10.607z"
              />
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Things I know I&#39;ll forget</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>

</body>

</html>
